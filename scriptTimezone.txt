CONN SYS/VIASOFT AS SYSDBA

PURGE DBA_RECYCLEBIN;

EXEC DBMS_APPLICATION_INFO.SET_CLIENT_INFO('UPG_TZV');

ALTER SESSION SET "_WITH_SUBQUERY"=MATERIALIZE;

ALTER SESSION SET "_SIMPLE_VIEW_MERGING"=TRUE;

EXEC DBMS_DST.BEGIN_PREPARE(36);

SET SERVEROUTPUT ON
BEGIN
	DBMS_DST.FIND_AFFECTED_TABLES
	(AFFECTED_TABLES => 'SYS.DST$AFFECTED_TABLES',
	LOG_ERRORS => TRUE,
	LOG_ERRORS_TABLE => 'SYS.DST$ERROR_TABLE');
END;
/

EXEC DBMS_DST.END_PREPARE;

SHUTDOWN IMMEDIATE;

STARTUP UPGRADE;
SET SERVEROUTPUT ON

PURGE DBA_RECYCLEBIN;

TRUNCATE TABLE SYS.DST$TRIGGER_TABLE;
TRUNCATE TABLE SYS.DST$AFFECTED_TABLES;
TRUNCATE TABLE SYS.DST$ERROR_TABLE;

EXEC DBMS_APPLICATION_INFO.SET_CLIENT_INFO('UPG_TZV')

ALTER SESSION SET "_WITH_SUBQUERY"=MATERIALIZE;

EXEC DBMS_DST.BEGIN_UPGRADE(36);

SHUTDOWN IMMEDIATE;
STARTUP;

ALTER SESSION SET "_WITH_SUBQUERY"=MATERIALIZE;
ALTER SESSION SET "_SIMPLE_VIEW_MERGING"=TRUE;

SET SERVEROUTPUT ON
VAR NUMFAIL NUMBER
BEGIN
DBMS_DST.UPGRADE_DATABASE(:NUMFAIL,
PARALLEL => TRUE,
LOG_ERRORS => TRUE,
LOG_ERRORS_TABLE => 'SYS.DST$ERROR_TABLE',
LOG_TRIGGERS_TABLE => 'SYS.DST$TRIGGER_TABLE',
ERROR_ON_OVERLAP_TIME => FALSE,
ERROR_ON_NONEXISTING_TIME => FALSE);
DBMS_OUTPUT.PUT_LINE('FAILURES:'|| :NUMFAIL);
END;
/

VAR fail number
BEGIN
DBMS_DST.END_UPGRADE(:fail);
DBMS_OUTPUT.PUT_LINE('Failures:'|| :fail);
END;
/

EXIT;
